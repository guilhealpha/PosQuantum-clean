name: Build PosQuantum Desktop - Multiplataforma

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  APP_NAME: PosQuantum
  APP_VERSION: 2.0.0

jobs:
  build:
    strategy:
      matrix:
        os: [windows-2022, ubuntu-22.04, macos-12]
        include:
          - os: windows-2022
            platform: windows
            executable: PosQuantum.exe
            artifact_name: PosQuantum-Windows-x64
          - os: ubuntu-22.04
            platform: linux
            executable: PosQuantum
            artifact_name: PosQuantum-Linux-x64
          - os: macos-12
            platform: macos
            executable: PosQuantum
            artifact_name: PosQuantum-macOS-x64
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Setup Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: Verificar sistema
      run: |
        echo "Sistema: ${{ matrix.platform }}"
        python --version
        pip --version
        
    - name: Instalar dependÃªncias do sistema (Linux)
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-xinerama0 \
          libxcb-xfixes0
        
    - name: Instalar dependÃªncias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verificar dependÃªncias crÃ­ticas
      run: |
        python -c "import PyQt6; print('âœ… PyQt6 OK')"
        python -c "import cryptography; print('âœ… Cryptography OK')"
        python -c "import numpy; print('âœ… Numpy OK')"
        python -c "from main import PosQuantumMainWindow; print('âœ… Main import OK')"
        
    - name: Criar executÃ¡vel
      run: |
        python -m PyInstaller \
          --onefile \
          --windowed \
          --name=${{ env.APP_NAME }} \
          --add-data="i18n.py:." \
          --add-data="crypto_tab.py:." \
          --add-data="blockchain_tab.py:." \
          --add-data="p2p_tab.py:." \
          --add-data="remaining_modules_tabs.py:." \
          --hidden-import=PyQt6 \
          --hidden-import=PyQt6.QtCore \
          --hidden-import=PyQt6.QtGui \
          --hidden-import=PyQt6.QtWidgets \
          --hidden-import=PyQt6.QtNetwork \
          --hidden-import=cryptography \
          --hidden-import=numpy \
          --hidden-import=hashlib \
          --hidden-import=json \
          --hidden-import=socket \
          --hidden-import=threading \
          --hidden-import=asyncio \
          --hidden-import=ssl \
          --exclude-module=tkinter \
          --exclude-module=matplotlib \
          --exclude-module=scipy \
          --exclude-module=pandas \
          main.py
        
    - name: Verificar executÃ¡vel criado
      shell: bash
      run: |
        if [ -f "dist/${{ matrix.executable }}" ]; then
          size=$(du -h "dist/${{ matrix.executable }}" | cut -f1)
          echo "âœ… ExecutÃ¡vel criado: $size"
          ls -la dist/
        else
          echo "âŒ ExecutÃ¡vel nÃ£o foi criado"
          ls -la dist/ || echo "Pasta dist nÃ£o existe"
          exit 1
        fi
        
    - name: Testar executÃ¡vel (verificaÃ§Ã£o bÃ¡sica)
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Verificar header PE no Windows
          if command -v file >/dev/null 2>&1; then
            file "dist/${{ matrix.executable }}"
          else
            echo "Comando file nÃ£o disponÃ­vel, pulando verificaÃ§Ã£o"
          fi
        else
          # Verificar executÃ¡vel Unix
          file "dist/${{ matrix.executable }}"
          chmod +x "dist/${{ matrix.executable }}"
        fi
        
    - name: Renomear executÃ¡vel com plataforma
      shell: bash
      run: |
        cd dist
        if [ "${{ matrix.platform }}" = "windows" ]; then
          mv "${{ matrix.executable }}" "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-Windows-x64.exe"
        else
          mv "${{ matrix.executable }}" "${{ env.APP_NAME }}-${{ env.APP_VERSION }}-${{ matrix.platform }}-x64"
        fi
        ls -la
        
    - name: Upload executÃ¡vel como artefato
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/*
        retention-days: 30
        
  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4
      
    - name: Download todos os artefatos
      uses: actions/download-artifact@v3
      with:
        path: artifacts
        
    - name: Preparar arquivos para release
      run: |
        mkdir -p release
        find artifacts -name "*" -type f -exec cp {} release/ \;
        ls -la release/
        
    - name: Criar tag automÃ¡tica
      id: create_tag
      run: |
        TAG="v${{ env.APP_VERSION }}-$(date +%Y%m%d-%H%M%S)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag $TAG
        git push origin $TAG
        
    - name: Criar Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.create_tag.outputs.tag }}
        name: "PosQuantum Desktop ${{ env.APP_VERSION }} - $(date +%Y-%m-%d)"
        body: |
          ğŸ›¡ï¸ **PosQuantum Desktop v${{ env.APP_VERSION }}**
          
          ## ğŸš€ **Primeiro Software Desktop 100% PÃ³s-QuÃ¢ntico do Mundo!**
          
          ### âœ… **Funcionalidades Implementadas:**
          - ğŸ” **Criptografia PÃ³s-QuÃ¢ntica** - ML-KEM-768, ML-DSA-65, SPHINCS+
          - â›“ï¸ **Blockchain QuantumCoin** - QTC, QTG, QTS com mineraÃ§Ã£o
          - ğŸŒ **Rede P2P** - ComunicaÃ§Ã£o intercomputadores real
          - ğŸ›°ï¸ **ComunicaÃ§Ã£o SatÃ©lite** - Starlink, OneWeb, Kuiper
          - ğŸ¤– **IA de SeguranÃ§a** - DetecÃ§Ã£o de ameaÃ§as
          - ğŸ’¾ **Storage DistribuÃ­do** - Backup automÃ¡tico
          - ğŸ†” **Sistema de Identidade** - Certificados quÃ¢nticos
          - ğŸ“‹ **Compliance** - ISO27001, FIPS140-2, SOC2
          - ğŸ“Š **Analytics** - MÃ©tricas em tempo real
          - ğŸŒ **Idiomas** - PortuguÃªs e InglÃªs
          - âš™ï¸ **ConfiguraÃ§Ãµes** - Painel unificado
          
          ### ğŸ“¦ **Downloads DisponÃ­veis:**
          - **Windows x64** - PosQuantum-${{ env.APP_VERSION }}-Windows-x64.exe
          - **Linux x64** - PosQuantum-${{ env.APP_VERSION }}-linux-x64
          - **macOS x64** - PosQuantum-${{ env.APP_VERSION }}-macos-x64
          
          ### ğŸ”§ **Requisitos do Sistema:**
          - **Windows:** Windows 10/11 x64
          - **Linux:** Ubuntu 20.04+ ou equivalente
          - **macOS:** macOS 10.15+ x64
          - **RAM:** MÃ­nimo 4GB, Recomendado 8GB
          - **EspaÃ§o:** 500MB livres
          
          ### ğŸš€ **Como Usar:**
          1. Baixe o executÃ¡vel para seu sistema
          2. Execute o arquivo (no Linux/macOS: `chmod +x` primeiro)
          3. A interface PyQt6 serÃ¡ aberta
          4. Explore as 11 abas funcionais
          5. Configure a rede P2P para comunicaÃ§Ã£o intercomputadores
          
          **ğŸ¯ Desenvolvido pela equipe PosQuantum**
        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

