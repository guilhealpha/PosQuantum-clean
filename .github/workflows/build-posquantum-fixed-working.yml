name: ğŸš€ Build PosQuantum Desktop - FIXED WORKING

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  APP_NAME: PosQuantumDesktop
  APP_VERSION: '3.0.0'

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0
        
    - name: âš¡ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.6.1 cryptography==41.0.7 requests==2.31.0 pyinstaller==6.3.0
        
    - name: ğŸ§ª Test basic imports
      run: |
        export QT_QPA_PLATFORM=offscreen
        python -c "
        try:
            import sys
            print('Python version:', sys.version)
            import PyQt6.QtCore
            print('PyQt6 imported successfully')
            import cryptography
            print('Cryptography imported successfully')
            print('[âœ…] All basic imports successful')
        except Exception as e:
            print(f'[âŒ] Import failed: {e}')
            exit(1)
        "

  build-windows:
    name: ğŸ—ï¸ Build Windows Executable
    runs-on: windows-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: âš¡ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.6.1 cryptography==41.0.7 requests==2.31.0 pyinstaller==6.3.0
        
    - name: ğŸ§ª Test imports on Windows
      run: |
        python -c "
        try:
            import sys
            print('Python version:', sys.version)
            import PyQt6.QtCore
            print('PyQt6 imported successfully')
            import cryptography
            print('Cryptography imported successfully')
            print('[OK] All imports successful on Windows')
        except Exception as e:
            print(f'[ERROR] Import failed: {e}')
            exit(1)
        "
        
    - name: ğŸ—ï¸ Build executable with PyInstaller
      run: |
        pyinstaller --onefile --windowed --name=${{ env.APP_NAME }} --distpath=dist --workpath=build --specpath=. main.py
        
    - name: âœ… Verify executable creation
      run: |
        if (Test-Path "dist\${{ env.APP_NAME }}.exe") {
          Write-Host "[âœ…] Windows executable created successfully"
          $fileInfo = Get-Item "dist\${{ env.APP_NAME }}.exe"
          Write-Host "File size: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
          Write-Host "File path: $($fileInfo.FullName)"
        } else {
          Write-Host "[âŒ] Windows executable not found"
          if (Test-Path dist) {
            Write-Host "Contents of dist directory:"
            Get-ChildItem dist
          }
          exit 1
        }
        
    - name: ğŸ“¤ Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Windows-v${{ env.APP_VERSION }}
        path: dist/${{ env.APP_NAME }}.exe
        retention-days: 30

  build-linux:
    name: ğŸ§ Build Linux Executable
    runs-on: ubuntu-22.04
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0
        
    - name: âš¡ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.6.1 cryptography==41.0.7 requests==2.31.0 pyinstaller==6.3.0
        
    - name: ğŸ§ª Test basic imports
      run: |
        export QT_QPA_PLATFORM=offscreen
        python -c "
        try:
            import sys
            print('Python version:', sys.version)
            import PyQt6.QtCore
            print('PyQt6 imported successfully')
            import cryptography
            print('Cryptography imported successfully')
            print('[OK] All basic imports successful')
        except Exception as e:
            print(f'[ERROR] Import failed: {e}')
            exit(1)
        "
        
    - name: ğŸ—ï¸ Build executable with PyInstaller
      run: |
        export QT_QPA_PLATFORM=offscreen
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 2
        pyinstaller --onefile --name=${{ env.APP_NAME }} --distpath=dist --workpath=build --specpath=. main.py
        
    - name: âœ… Verify executable creation
      run: |
        if [ -f "dist/${{ env.APP_NAME }}" ]; then
          echo "[âœ…] Linux executable created successfully"
          ls -la "dist/${{ env.APP_NAME }}"
          file "dist/${{ env.APP_NAME }}"
          echo "File size: $(du -h dist/${{ env.APP_NAME }} | cut -f1)"
        else
          echo "[âŒ] Linux executable not found"
          if [ -d dist ]; then
            echo "Contents of dist directory:"
            ls -la dist/
          fi
          exit 1
        fi
        
    - name: ğŸ“¤ Upload Linux executable
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Linux-v${{ env.APP_VERSION }}
        path: dist/${{ env.APP_NAME }}
        retention-days: 30

  create-release:
    name: ğŸš€ Create Release
    runs-on: ubuntu-22.04
    needs: [build-windows, build-linux]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Windows-v${{ env.APP_VERSION }}
        path: ./release/windows/
        
    - name: ğŸ“¥ Download Linux executable
      uses: actions/download-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-Linux-v${{ env.APP_VERSION }}
        path: ./release/linux/
        
    - name: ğŸ“‹ Verify downloaded files
      run: |
        echo "Verifying downloaded artifacts..."
        ls -la release/
        if [ -f "release/windows/${{ env.APP_NAME }}.exe" ]; then
          echo "[âœ…] Windows executable found"
          ls -la "release/windows/${{ env.APP_NAME }}.exe"
        else
          echo "[âŒ] Windows executable not found"
          ls -la release/windows/
        fi
        
        if [ -f "release/linux/${{ env.APP_NAME }}" ]; then
          echo "[âœ…] Linux executable found"
          ls -la "release/linux/${{ env.APP_NAME }}"
        else
          echo "[âŒ] Linux executable not found"
          ls -la release/linux/
        fi
        
    - name: ğŸ·ï¸ Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ env.APP_VERSION }}-${{ github.run_number }}
        name: PosQuantum Desktop v${{ env.APP_VERSION }}-${{ github.run_number }}
        body: |
          ## ğŸš€ PosQuantum Desktop Release v${{ env.APP_VERSION }}-${{ github.run_number }}
          
          ### âœ¨ Features:
          - ğŸ” Post-quantum cryptography implementation
          - ğŸ–¥ï¸ Cross-platform desktop application
          - ğŸªŸ Windows and ğŸ§ Linux executables
          - ğŸ›¡ï¸ Advanced security features
          
          ### ğŸ“¥ Downloads:
          - **Windows**: PosQuantumDesktop.exe
          - **Linux**: PosQuantumDesktop
          
          ### ğŸ”§ Installation:
          1. Download the appropriate executable for your platform
          2. Run the executable directly (no installation required)
          3. For Linux: `chmod +x PosQuantumDesktop && ./PosQuantumDesktop`
          
          ### ğŸ“Š Build Info:
          - **Commit**: ${{ github.sha }}
          - **Build Date**: ${{ github.run_started_at }}
          - **Python Version**: ${{ env.PYTHON_VERSION }}
          
          ### ğŸ¯ Status: âœ… WORKING BUILD
        files: |
          release/windows/${{ env.APP_NAME }}.exe
          release/linux/${{ env.APP_NAME }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-summary:
    name: ğŸ“Š Build Summary
    needs: [test, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“‹ Display Build Results
      run: |
        echo "ğŸ† PosQuantum Desktop Build Summary"
        echo "=================================="
        echo "âœ… Test Job: ${{ needs.test.result }}"
        echo "ğŸªŸ Windows Build: ${{ needs.build-windows.result }}"
        echo "ğŸ§ Linux Build: ${{ needs.build-linux.result }}"
        echo "ğŸ“… Build Date: $(date)"
        echo "ğŸ·ï¸ Version: ${{ env.APP_VERSION }}"
        
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.build-windows.result }}" == "success" ] && [ "${{ needs.build-linux.result }}" == "success" ]; then
          echo "ğŸ‰ ALL BUILDS SUCCESSFUL! ğŸ‰"
          echo "ğŸ“¦ Executables are ready for download in the 'Artifacts' section."
        else
          echo "âŒ Some builds failed. Check the logs above for details."
        fi

